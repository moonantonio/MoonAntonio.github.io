<!DOCTYPE html>
<html lang="es-es">
<head>
	<title>MEGA API CLIENT [C#]&middot; Antonio Moon´s</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Moon Antonio">
	<meta name="description" content="un blog sobre mi, juegos, desarrollo y anime">
	<meta name="keywords" content="Moon,Antonio,Dev,Game">
	<meta name="generator" content="Hugo 0.50" />

	<!-- CSS -->
	<link rel="stylesheet" href="https://moonantonio.github.io/css/main.css">
	<link id="dark-mode-theme" rel="stylesheet" href="/css/dark.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="https://moonantonio.github.io/favicon.ico" type="image/x-icon">

	<!-- RSS -->
	

	<!-- Font Awesome -->
	<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
    <header class="site-header">
	<div class="branding">
		<a href="https://moonantonio.github.io/">
		<img class="avatar" src="https://moonantonio.github.io/img/avatar.png" alt="avatar"/>
		</a>
		<h1 class="site-title">
			<i class="fa fa-angle-right"></i>
			<a href="https://moonantonio.github.io/">Antonio Moon´s</a>
			<span class="logo-cursor "></span>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			<li><a href="/about/">  </a></li>

			<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/devblog/" title="devBlog">
  		</i>&nbsp; devBlog</a> <i class="fa fa-gamepad" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/backdoor" title="backDoor">
  		</i>&nbsp; backDoor</a> <i class="fa fa-black-tie" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://github.com/MoonAntonio/rec.repos" title="src">
  		</i>&nbsp; src</a> <i class="fa fa-code" aria-hidden="true"></i>
  </a>
</li>

<li class="list-group">
  <a class="list-group-item" href="https://moonantonio.github.io/portfolio/" title="moon">
  		</i>&nbsp; moon</a> <i class="fa fa-terminal" aria-hidden="true"></i>
  </a>
</li>

<li class="icon">
	<a href="https://moonantonio.github.io/" title="&#43;">
		</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>
	</a>
</li>





<li>
	<a href="mailto:antoniomt.moon@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>











<li>
	<a href="https://github.com/MoonAntonio" title="GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>

























<li>
	<a href="https://gitlab.com/MoonAntonio" title="Gitlab">
		<i class="fa fa-fw fa-gitlab"></i>
	</a>
</li>

<li>
	<a href="https://trello.com/antoniomoon" title="Trello">
		<i class="fa fa-fw fa-trello"></i>
	</a>
</li>



			<a id="dark-mode-toggle" class="fa fa-moon-o" title="darkmode"></a>
		</ul>
	</nav>
</header>

    <div class="content">
    <script src="https://moonantonio.github.io/js/darkmode.js"></script>
	<article class="feature-image">
		<header style="background-image: url('https://moonantonio.github.io/img/b/b004.jpg')">
			<h1 class="title">MEGA API CLIENT [C#]</h1>
		</header>

	<section class="post-content">
		<p><center><img src="/img/c/mapic.png" alt="001" /></center></p>

<p>(ACTUALIZADO A 21/07/2022)</p>

<p>Mega es el sucesor del servicio de archivos en la nube Megaupload, para aquellos a los que no les suena ninguno de los dos es como un dropbox, un servicio gratuito o de pago dependiendo del espacio que utilizamos para poder subir nuestros archivos. En mi opinión es un servicio increíble que nos permite almacenar copias de seguridad de archivos en la nube y/o compartirlos.</p>

<p>En esta entrada mostraré como desde un proyecto en .Net en este caso con C# podéis <strong>subir archivos a mega</strong>. Además de subir archivos también podréis <strong>eliminar, modificar, mover</strong> y varias funciones más pero eso lo veremos en otra entrada. Para comenzar tendréis que incorporar a vuestro proyecto varias referencias, si lo realizáis desde el administrador de paquetes nuget de Visual Studio ahorraréis tiempo y faena. Para abrir el administrador de paquetes nuget vamos a la barra principal de arriba y seleccionamos proyecto y administrar paquetes nuget. En la caja de búsqueda ponéis “<strong>mega.co.nz</strong>” sin comillas, y debe aparecer una librería que hará de cliente contra los servidores de mega, la seleccionáis y le dais a instalar. Además instalará automáticamente otra llamada <strong>Newtonsoft.Json que utilizará la librería mega para realizar algunas acciones</strong>.</p>

<p>Tenemos el proyecto listo para empezar a utilizar los métodos y funciones que nos facilita mega en la clase que queramos, con ello vamos a la clase desde la que queramos que se suba el archivo y añadimos dos directivas using, la primera hace referencia a la <strong>api mega</strong> y la segunda nos permitirá crear <strong>un hilo y de este modo no bloquear nuestra aplicación</strong> mientras se realizan algunas tareas en línea:</p>

<pre><code class="language-C#">using CG.Web.MegaApiClient;
using System.Threading.Tasks;
</code></pre>

<p>Ahora vamos con el método que se encargará de realizar la subida del archivo, actualizar la barra de progreso, y actualizar el texto de un label que irá informando al usuario de como va el proceso. El método es llamado dentro del evento “Shown” del form, y el form lo llamo mediante “ShowDialog()” desde el evento click de un botón de otro form, de esta manera es como una ventana emergente que no desaparecerá hasta que termine el proceso (entre 10 y 40 segundos). Para que quede mas claro, tenemos el “Form1” con un botón, este botón llamará al “Form2” mediante “ShowDialog()”, y dentro del evento “Shown” del “Form2” realizaremos la llamada al método encargado de subir el archivo “subirArchivoAMega()”.</p>

<pre><code class="language-C#">//Declaración de un hilo
private Thread t;
private string cuenta = &quot;cuenta@dominio.com&quot;;
private string contra = &quot;******************&quot;;
private string nomCar = &quot;carpeta&quot;;
 

 //Evento Shown que instancia y ejecuta el hilo (este evento se ejecuta después del Load).
 private void Form2_Shown(object sender, EventArgs e)
 {
     //Instancia un hilo para ejecutar el método &quot;subirArchivoAMega&quot;.
     t = new Thread(subirArchivoAMega);
     t.Start();
 }
// Método que se encarga de subir el archivo a la nuve con la api &quot;Mega&quot;.
private void subirArchivoAMega() 
{
    try
    {
        // Actualizar el label para informar al usuario.
        txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Conectando como &quot; + cuenta; }));
        // Aumentar la barra de progreso.
        barraProgreso.Invoke(new MethodInvoker(delegate { barraProgreso.PerformStep(); }));
        // Instancia de un cliente para conectar con mega.
        MegaApiClient cliente = new MegaApiClient();
        // Inicio de sesi�n con el cliente, pasando el correo y la contrase�a de la cuenta mega a la
        // que se sube el archivo.
        cliente.Login(cuenta, contra);
        // Aumentar la barra de progreso.
        barraProgreso.Invoke(new MethodInvoker(delegate { barraProgreso.PerformStep(); }));
        // Actualizar el label para informar al usuario.
        txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Obteniendo directorios...&quot;; }));
        // Obtenemos los nodos (directorios/archivos) de la cuenta dentro de una variable.
        var nodos = cliente.GetNodes();
        // Actualizar el label para informar al usuario.
        txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Buscando carpeta &quot; + nomCar + &quot;...&quot;; }));
        // Comprobar si existe alg�n nodo (directorio) que se llame &quot;nomCar&quot; (en mi caso quiero subir el
        // archivo a dicha carpeta).
        bool existe = cliente.GetNodes().Any(n =&gt; n.Name == nomCar);

        // Crear dos nodos.
        INode root;
        INode carpeta;

        // Si el directorio nomCar existe, se obtiene. Si no existe, se crea.
        if (existe == true)
        {
            // Actualizar el label para informar al usuario.
            txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Obteniendo la carpeta &quot; + nomCar + &quot;....&quot;; }));
            // Aumentar la barra de progreso.
            barraProgreso.Invoke(new MethodInvoker(delegate { barraProgreso.PerformStep(); }));
            // Obtenemos el directorio.
            carpeta = nodos.Single(n =&gt; n.Name == nomCar);
        }
        else
        {
            // Actualizar label para informar al usuario.
            txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Creando carpeta &quot; + nomCar + &quot;...&quot;; }));
            // Aumentar la barra de progreso.
            barraProgreso.Invoke(new MethodInvoker(delegate { barraProgreso.PerformStep(); }));
            // Obtenemos el nodo ra�z.
            root = nodos.Single(n =&gt; n.Type == NodeType.Root);
            // Creamos el directorio llamado &quot;nomCar&quot; en la ra�z.
            carpeta = cliente.CreateFolder(nomCar, root);
        }

        // Aumentar la barra de progreso.
        barraProgreso.Invoke(new MethodInvoker(delegate { barraProgreso.PerformStep(); }));
        // Actualizar label para informar al usuario.
        txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Subiendo archivo...&quot;; }));
        // Aumentar la barra de progreso.
        barraProgreso.Invoke(new MethodInvoker(delegate { barraProgreso.PerformStep(); }));
        // Subimos el archivo al directorio &quot;nomCar&quot;, pasando la ruta del archivo a subir
        // y el directorio de mega donde debe subirlo.
        INode archivo = cliente.UploadFile(@&quot;ruta/del/archivo.png&quot;, carpeta);
        // Obtener el link de descarga del archivo subido por si se requiere para algo.
        Uri downloadUrl = cliente.GetDownloadLink(archivo);
        // Actualizar label para informar al usuario.
        txtInfo.Invoke(new MethodInvoker(delegate { txtInfo.Text = &quot;Archivo subido con �xito.&quot;; }));
    }
    catch (Exception error)
    {
        // Mensaje en pantalla para informar al usuario del error.
        MessageBox.Show(&quot;Error al intentar subir el archivo. &quot; + error.Message, &quot;Error&quot;, 
            MessageBoxButtons.OK, MessageBoxIcon.Error);
    }

    // No se puede cerrar el form desde un subproceso ya que no es desde donde se ha creado.
    // Con esta llamada podemos cerrarlo.
    this.Invoke((MethodInvoker)delegate {this.Close();});
}

</code></pre>

<p>Si os fijáis, hago <strong>constantemente referencias a elementos del form</strong>, el motivo es para que el usuario sepa en todo momento la evolución del proceso. Para acceder a los componentes de un form no podemos hacerlo directamente desde un subproceso, por eso utilizamos el método “Invoke” que ejecuta el <strong>delegado asignado al subproceso y nos permite comunicarnos con el usuario</strong>.</p>

<p>Finalmente muestro mi diseño del form para que veáis el total de elementos a los que hago referencia en el método, aunque podéis implementar el diseño que os guste.</p>

<p><center><img src="/img/c/mapic.jpg" alt="001" /></center></p>

<p><center><a href="https://bit.ly/3PLteQD" class="button"><i class="fa fa-github-alt"></i> GitHub</a></center></p>

<p><strong>.\Moon</strong></p>


		
	</section>
    </div>

    <footer class="site-footer">
	<p class="text">&copy; 2022 - Moon Antonio</p>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-89564434-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</body>
</html>
